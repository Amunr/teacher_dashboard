
{% extends "layout.html" %}

{% block title %}Layout Builder - Question Management{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-primary mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>
                        <span id="layoutNameHeader">Layout Builder</span>
                    </h2>
                    <div class="text-muted small" id="layoutIdHeader"></div>
                </div>
                <button class="btn btn-success btn-lg" onclick="addDomain()">
                    <i class="bi bi-plus-circle me-2"></i>Add Domain
                </button>
            </div>
            <p class="text-muted">Manage your question hierarchy and metadata structure</p>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="row">
        <div class="col-12">
            <div class="card border-3 rounded-4 shadow-lg">
                <div class="card-body p-5">
                    <!-- Domains Container -->
                    <div id="domainsContainer">
                        <!-- Sample data will be populated here -->
                    </div>

                    <!-- Metadata Section (Always at bottom) -->
                    <div class="mt-5">
                        <div class="card border-info border-3 rounded-4 shadow-lg">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="fw-bold text-info mb-0">
                                    <i class="bi bi-database me-2"></i>MetaData
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="metadataContainer">
                                    <!-- Metadata questions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Controls -->
                    <div class="row mt-5">
                        <div class="col-md-4">
                            <label for="layoutStartDate" class="form-label fw-bold">Layout Start Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutStartDate" value="{{ current_year }}-01-01">
                        </div>
                        <div class="col-md-4">
                            <label for="layoutEndDate" class="form-label fw-bold">Layout End Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutEndDate" value="{{ current_year }}-12-31">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary btn-lg w-100" onclick="submitLayout()">
                                <i class="bi bi-check-circle me-2"></i>Submit Layout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ========================================
// GLOBAL VARIABLES
// ========================================
let layoutData = {
    domains: [],
    metadata: []
};

let questionCounter = 1;

// ========================================
// SAMPLE DATA (Replace with API call)
// ========================================
const sampleData = {
    domains: [
        {
            id: 1,
            name: "Language Development",
            subdomains: [
                {
                    id: 1,
                    name: "Vocabulary",
                    questions: [
                        { id: 1, name: "What is your name?", question_id: 1 },
                        { id: 2, name: "How old are you?", question_id: 2 }
                    ]
                },
                {
                    id: 2,
                    name: "Grammar",
                    questions: [
                        { id: 3, name: "Can you form a sentence?", question_id: 3 }
                    ]
                }
            ]
        },
        {
            id: 2,
            name: "Cognitive Development",
            subdomains: [
                {
                    id: 3,
                    name: "Problem Solving",
                    questions: [
                        { id: 4, name: "Solve this puzzle", question_id: 4 }
                    ]
                }
            ]
        }
    ],
    metadata: [
        { id: 1, name: "Student ID", question_id: 101 },
        { id: 2, name: "Assessment Date", question_id: 102 },
        { id: 3, name: "Teacher Name", question_id: 103 }
    ]
};

// ========================================
// API FUNCTIONS (Placeholders for backend integration)
// ========================================

// ðŸ”§ REPLACE WITH YOUR ACTUAL API CALL
async function fetchCurrentLayout() {
    try {
        // This should call your API to get current layout data
        // const response = await fetch('/api/layout/current');
        // const data = await response.json();
        // return data;
        // For now, return sample data
        return Object.assign({ layout_name: 'Sample Layout', layout_id: 1 }, sampleData);
    } catch (error) {
        console.error('Error fetching current layout:', error);
        return { domains: [], metadata: [], layout_name: '', layout_id: '' };
    }
}

// ðŸ”§ REPLACE WITH YOUR ACTUAL API CALL
async function submitLayoutToBackend(questionsTable) {
    try {
        // This should call your API to save the layout
        // const response = await fetch('/api/layout/submit', {
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json',
        //     },
        //     body: JSON.stringify(questionsTable)
        // });
        // return await response.json();
        console.log('Layout submitted:', questionsTable);
        alert('Layout submitted successfully!');
        return { success: true };
    } catch (error) {
        console.error('Error submitting layout:', error);
        alert('Error submitting layout. Please try again.');
        return { success: false };
    }
}

// ========================================
// SUBMIT LAYOUT FUNCTION
// ========================================
async function submitLayout() {
    const startDate = document.getElementById('layoutStartDate').value;
    const endDate = document.getElementById('layoutEndDate').value;
    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }
    // Convert layout data to questions table format
    const questionsTable = convertToQuestionsTable(startDate, endDate);
    console.log('Submitting layout:', questionsTable);
    const result = await submitLayoutToBackend(questionsTable);
    if (result.success) {
        console.log('Layout submitted successfully');
    }
}

function convertToQuestionsTable(startDate, endDate) {
    const questions = [];
    // Use layoutData.layout_id and layoutData.date_edited if available, else generate
    const layout_id = layoutData.layout_id || Date.now();
    const date_edited = layoutData.date_edited || new Date().toISOString().slice(0, 10);
    // Convert domains and subdomains to flat structure
    layoutData.domains.forEach(domain => {
        domain.subdomains.forEach(subdomain => {
            subdomain.questions.forEach(question => {
                questions.push({
                    layout_id,
                    date_edited,
                    is_current: layoutData.is_current || false,
                    year_start: startDate,
                    year_end: endDate,
                    domain: domain.name,
                    subdomain: subdomain.name,
                    index_id: question.question_id,
                    name: question.name
                });
            });
        });
    });
    // Add metadata questions
    layoutData.metadata.forEach(metadata => {
        questions.push({
            layout_id,
            date_edited,
            is_current: layoutData.is_current || false,
            year_start: startDate,
            year_end: endDate,
            domain: "MetaData",
            subdomain: "",
            index_id: metadata.question_id,
            name: metadata.name
        });
    });
    return questions;
}

// ========================================
// DOMAIN MANAGEMENT FUNCTIONS
// ========================================
function addDomain() {
    const domainId = Date.now();
    const newDomain = {
        id: domainId,
        name: "New Domain",
        subdomains: []
    };
    
    layoutData.domains.push(newDomain);
    renderLayout();
}

function deleteDomain(domainId) {
    layoutData.domains = layoutData.domains.filter(d => d.id !== domainId);
    renderLayout();
}

function updateDomainName(domainId, newName) {
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        domain.name = newName;
    }
}

// ========================================
// SUBDOMAIN MANAGEMENT FUNCTIONS
// ========================================
function addSubdomain(domainId) {
    const subdomainId = Date.now();
    const newSubdomain = {
        id: subdomainId,
        name: "New Subdomain",
        questions: []
    };
    
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        domain.subdomains.push(newSubdomain);
        renderLayout();
    }
}

function deleteSubdomain(domainId, subdomainId) {
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        domain.subdomains = domain.subdomains.filter(s => s.id !== subdomainId);
        renderLayout();
    }
}

function updateSubdomainName(domainId, subdomainId, newName) {
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        const subdomain = domain.subdomains.find(s => s.id === subdomainId);
        if (subdomain) {
            subdomain.name = newName;
        }
    }
}

// ========================================
// QUESTION MANAGEMENT FUNCTIONS
// ========================================
function addQuestion(domainId, subdomainId) {
    const questionId = Date.now();
    const newQuestion = {
        id: questionId,
        name: "New Question",
        question_id: questionCounter++
    };
    
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        const subdomain = domain.subdomains.find(s => s.id === subdomainId);
        if (subdomain) {
            subdomain.questions.push(newQuestion);
            renderLayout();
        }
    }
}

function deleteQuestion(domainId, subdomainId, questionId) {
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        const subdomain = domain.subdomains.find(s => s.id === subdomainId);
        if (subdomain) {
            subdomain.questions = subdomain.questions.filter(q => q.id !== questionId);
            renderLayout();
        }
    }
}

function updateQuestion(domainId, subdomainId, questionId, field, value) {
    const domain = layoutData.domains.find(d => d.id === domainId);
    if (domain) {
        const subdomain = domain.subdomains.find(s => s.id === subdomainId);
        if (subdomain) {
            const question = subdomain.questions.find(q => q.id === questionId);
            if (question) {
                question[field] = value;
            }
        }
    }
}

// ========================================
// METADATA MANAGEMENT FUNCTIONS
// ========================================
function updateMetadataQuestion(questionId, field, value) {
    const metadata = layoutData.metadata.find(m => m.id === questionId);
    if (metadata) {
        metadata[field] = value;
    }
}

// ========================================
// RENDERING FUNCTIONS
// ========================================
function renderLayout() {
    renderDomains();
    renderMetadata();
}

function renderDomains() {
    const container = document.getElementById('domainsContainer');
    container.innerHTML = '';
    
    layoutData.domains.forEach(domain => {
        const domainHtml = `
            <div class="domain-card mb-4">
                <div class="card border-primary border-3 rounded-4 shadow-lg">
                    <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-diagram-3 text-primary me-2"></i>
                            <input type="text" 
                                   class="form-control form-control-lg border-0 bg-transparent fw-bold" 
                                   value="${domain.name}"
                                   onchange="updateDomainName(${domain.id}, this.value)">
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteDomain(${domain.id})">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${renderSubdomains(domain)}
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" onclick="addSubdomain(${domain.id})">
                                <i class="bi bi-plus-circle me-2"></i>Add Subdomain
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += domainHtml;
    });
}

function renderSubdomains(domain) {
    let subdomainsHtml = '';
    
    domain.subdomains.forEach(subdomain => {
        subdomainsHtml += `
            <div class="subdomain-card mb-3 ms-4">
                <div class="card border-secondary border-2 rounded-3">
                    <div class="card-header bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-collection text-secondary me-2"></i>
                            <input type="text" 
                                   class="form-control form-control-sm border-0 bg-transparent fw-semibold" 
                                   value="${subdomain.name}"
                                   onchange="updateSubdomainName(${domain.id}, ${subdomain.id}, this.value)">
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSubdomain(${domain.id}, ${subdomain.id})">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${renderQuestions(domain.id, subdomain)}
                        <div class="text-center mt-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="addQuestion(${domain.id}, ${subdomain.id})">
                                <i class="bi bi-plus-circle me-1"></i>Add Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    return subdomainsHtml;
}

function renderQuestions(domainId, subdomain) {
    let questionsHtml = '';
    
    subdomain.questions.forEach(question => {
        questionsHtml += `
            <div class="question-row mb-2 ms-4">
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" 
                               class="form-control form-control-sm border-info border-2 rounded-3" 
                               placeholder="Question"
                               value="${question.name}"
                               onchange="updateQuestion(${domainId}, ${subdomain.id}, ${question.id}, 'name', this.value)">
                    </div>
                    <div class="col-md-4">
                        <input type="number" 
                               class="form-control form-control-sm border-info border-2 rounded-3" 
                               placeholder="Question ID"
                               value="${question.question_id}"
                               min="1"
                               step="1"
                               onchange="updateQuestion(${domainId}, ${subdomain.id}, ${question.id}, 'question_id', this.value)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteQuestion(${domainId}, ${subdomain.id}, ${question.id})">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    return questionsHtml;
}

function renderMetadata() {
    const container = document.getElementById('metadataContainer');
    container.innerHTML = '';
    
    layoutData.metadata.forEach(metadata => {
        const metadataHtml = `
            <div class="metadata-row mb-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" 
                               class="form-control form-control-sm border-info border-2 rounded-3 bg-light" 
                               value="${metadata.name}"
                               readonly>
                    </div>
                    <div class="col-md-4">
                        <input type="number" 
                               class="form-control form-control-sm border-info border-2 rounded-3" 
                               placeholder="ID"
                               value="${metadata.question_id}"
                               min="1"
                               step="1"
                               onchange="updateMetadataQuestion(${metadata.id}, 'question_id', this.value)">
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted text-center pt-2">
                            <i class="bi bi-lock"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += metadataHtml;
    });
}

// ========================================
// SUBMIT LAYOUT FUNCTION
// ========================================
async function submitLayout() {
    const startDate = document.getElementById('layoutStartDate').value;
    const endDate = document.getElementById('layoutEndDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }
    
    // Convert layout data to the required JSON format
    const layoutJson = convertToDatabaseFormat(startDate, endDate);
    
    console.log('Submitting layout:', layoutJson);
    
    const result = await submitLayoutToBackend(layoutJson);
    if (result.success) {
        console.log('Layout submitted successfully');
    }
}

function convertToDatabaseFormat(startDate, endDate) {
    const questions = [];
    
    // Convert domains and subdomains to flat structure
    layoutData.domains.forEach(domain => {
        domain.subdomains.forEach(subdomain => {
            subdomain.questions.forEach(question => {
                questions.push({
                    year_start: startDate,
                    year_end: endDate,
                    domain: domain.name,
                    subdomain: subdomain.name,
                    index_id: question.question_id,
                    name: question.name
                });
            });
        });
    });
    
    // Add metadata questions
    layoutData.metadata.forEach(metadata => {
        questions.push({
            year_start: startDate,
            year_end: endDate,
            domain: "MetaData",
            subdomain: "",
            index_id: metadata.question_id,
            name: metadata.name
        });
    });
    
    return questions;
}

// ========================================
// INITIALIZATION
// ========================================
async function initializeLayout() {
    try {
        const data = await fetchCurrentLayout();
        layoutData = data;
        // Set layout name and id in header
        document.getElementById('layoutNameHeader').textContent = layoutData.layout_name || 'Layout Builder';
        document.getElementById('layoutIdHeader').textContent = layoutData.layout_id ? `ID: ${layoutData.layout_id}` : '';
        renderLayout();
    } catch (error) {
        console.error('Error initializing layout:', error);
    }
}

$(document).ready(function() {
    initializeLayout();
});
</script>
{% endblock %} 