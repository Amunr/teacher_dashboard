{% extends "layout.html" %}

{% block title %}Layout Viewer - Question Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="fw-bold text-primary">
                    <i class="bi bi-eye me-2"></i>Layout Viewer
                </h2>
                <button class="btn btn-warning btn-lg" onclick="window.location.href='/linkage/edit'">
                    <i class="bi bi-pencil-square me-2"></i>Edit Layout
                </button>
            </div>
            <p class="text-muted">View your current question hierarchy and metadata structure</p>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="row">
        <div class="col-12">
            <div class="card border-3 rounded-4 shadow-lg">
                <div class="card-body p-5">
                    <!-- Domains Container -->
                    <div id="domainsContainer">
                        <!-- Sample data will be populated here -->
                    </div>

                    <!-- Metadata Section (Always at bottom) -->
                    <div class="mt-5">
                        <div class="card border-info border-3 rounded-4 shadow-lg">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="fw-bold text-info mb-0">
                                    <i class="bi bi-database me-2"></i>MetaData
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="metadataContainer">
                                    <!-- Metadata questions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Controls -->
                    <div class="row mt-5">
                        <div class="col-md-4">
                            <label for="layoutStartDate" class="form-label fw-bold">Layout Start Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutStartDate" value="{{ current_year }}-01-01" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="layoutEndDate" class="form-label fw-bold">Layout End Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutEndDate" value="{{ current_year }}-12-31" readonly>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-warning btn-lg w-100" onclick="window.location.href='/linkage/edit'">
                                <i class="bi bi-pencil-square me-2"></i>Edit Layout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ========================================
// GLOBAL VARIABLES
// ========================================
let layoutData = {
    domains: [],
    metadata: []
};

// ========================================
// SAMPLE DATA (Replace with API call)
// ========================================
const sampleData = {
    domains: [
        {
            id: 1,
            name: "Language Development",
            subdomains: [
                {
                    id: 1,
                    name: "Vocabulary",
                    questions: [
                        { id: 1, name: "What is your name?", question_id: 1 },
                        { id: 2, name: "How old are you?", question_id: 2 }
                    ]
                },
                {
                    id: 2,
                    name: "Grammar",
                    questions: [
                        { id: 3, name: "Can you form a sentence?", question_id: 3 }
                    ]
                }
            ]
        },
        {
            id: 2,
            name: "Cognitive Development",
            subdomains: [
                {
                    id: 3,
                    name: "Problem Solving",
                    questions: [
                        { id: 4, name: "Solve this puzzle", question_id: 4 }
                    ]
                }
            ]
        }
    ],
    metadata: [
        { id: 1, name: "Student ID", question_id: 101 },
        { id: 2, name: "Assessment Date", question_id: 102 },
        { id: 3, name: "Teacher Name", question_id: 103 }
    ]
};

// ========================================
// API FUNCTIONS (Placeholders for backend integration)
// ========================================

// ðŸ”§ REPLACE WITH YOUR ACTUAL API CALL
async function fetchCurrentLayout() {
    try {
        // This should call your API to get current layout data
        // const response = await fetch('/api/layout/current');
        // const data = await response.json();
        // return data;
        
        // For now, return sample data
        return sampleData;
    } catch (error) {
        console.error('Error fetching current layout:', error);
        return { domains: [], metadata: [] };
    }
}

// ========================================
// RENDERING FUNCTIONS (Read-only version)
// ========================================
function renderLayout() {
    renderDomains();
    renderMetadata();
}

function renderDomains() {
    const container = document.getElementById('domainsContainer');
    container.innerHTML = '';
    
    layoutData.domains.forEach(domain => {
        const domainHtml = `
            <div class="domain-card mb-4">
                <div class="card border-primary border-3 rounded-4 shadow-lg">
                    <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-diagram-3 text-primary me-2"></i>
                            <span class="fw-bold text-primary">${domain.name}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderSubdomains(domain)}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += domainHtml;
    });
}

function renderSubdomains(domain) {
    let subdomainsHtml = '';
    
    domain.subdomains.forEach(subdomain => {
        subdomainsHtml += `
            <div class="subdomain-card mb-3 ms-4">
                <div class="card border-secondary border-2 rounded-3">
                    <div class="card-header bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-collection text-secondary me-2"></i>
                            <span class="fw-semibold text-secondary">${subdomain.name}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderQuestions(domain.id, subdomain)}
                    </div>
                </div>
            </div>
        `;
    });
    
    return subdomainsHtml;
}

function renderQuestions(domainId, subdomain) {
    let questionsHtml = '';
    
    subdomain.questions.forEach(question => {
        questionsHtml += `
            <div class="question-row mb-2 ms-4">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${question.name}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${question.question_id}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted text-center pt-2">
                            <i class="bi bi-eye"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    return questionsHtml;
}

function renderMetadata() {
    const container = document.getElementById('metadataContainer');
    container.innerHTML = '';
    
    layoutData.metadata.forEach(metadata => {
        const metadataHtml = `
            <div class="metadata-row mb-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${metadata.name}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${metadata.question_id}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted text-center pt-2">
                            <i class="bi bi-lock"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += metadataHtml;
    });
}

// ========================================
// INITIALIZATION
// ========================================
async function initializeLayout() {
    try {
        const data = await fetchCurrentLayout();
        layoutData = data;
        renderLayout();
    } catch (error) {
        console.error('Error initializing layout:', error);
    }
}

$(document).ready(function() {
    initializeLayout();
});
</script>
{% endblock %} 