{% extends "layout.html" %}

{% block title %}Layout Viewer - Question Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-primary mb-0">
                        <i class="bi bi-eye me-2"></i>
                        <span id="layoutNameHeader">Layout Viewer</span>
                    </h2>
                    <div class="text-muted small" id="layoutIdHeader"></div>
                </div>
                <button class="btn btn-warning btn-lg" onclick="window.location.href='/linkage/edit'">
                    <i class="bi bi-pencil-square me-2"></i>Edit Layout
                </button>
            </div>
            <p class="text-muted">View your current question hierarchy and metadata structure</p>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="row">
        <div class="col-12">
            <div class="card border-3 rounded-4 shadow-lg">
                <div class="card-body p-5">
                    <!-- Domains Container -->
                    <div id="domainsContainer">
                        <!-- Sample data will be populated here -->
                    </div>

                    <!-- Metadata Section (Always at bottom) -->
                    <div class="mt-5">
                        <div class="card border-info border-3 rounded-4 shadow-lg">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="fw-bold text-info mb-0">
                                    <i class="bi bi-database me-2"></i>MetaData
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="metadataContainer">
                                    <!-- Metadata questions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Controls -->
                    <div class="row mt-5">
                        <div class="col-md-4">
                            <label for="layoutStartDate" class="form-label fw-bold">Layout Start Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutStartDate" value="{{ current_year }}-01-01" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="layoutEndDate" class="form-label fw-bold">Layout End Date:</label>
                            <input type="date" class="form-control form-control-lg border-warning border-3 rounded-4" 
                                   id="layoutEndDate" value="{{ current_year }}-12-31" readonly>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-warning btn-lg w-100" onclick="window.location.href='/linkage/edit'">
                                <i class="bi bi-pencil-square me-2"></i>Edit Layout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>

// ========================================
// GLOBALS
// ========================================
let layoutData = {
    domains: [],
    metadata: []
};

// ========================================
// API: fetch all questions, filter by layout_id from URL
// ========================================
function getLayoutIdFromUrl() {
    const match = window.location.pathname.match(/\/linkage\/view\/(\d+)/);
    return match ? parseInt(match[1]) : null;
}

async function fetchAllQuestions() {
    try {
        // const response = await fetch('/api/questions/all');
        // return await response.json();
        // Sample data for illustration:
        return [
            { layout_id: 3, layout_name: 'Language Layout', date_edited: "2024-06-10", is_current: true, domain: "Language Development", subdomain: "Vocabulary", index_id: 1, name: "What is your name?" },
            { layout_id: 3, layout_name: 'Language Layout', date_edited: "2024-06-10", is_current: true, domain: "Language Development", subdomain: "Vocabulary", index_id: 2, name: "How old are you?" },
            { layout_id: 3, layout_name: 'Language Layout', date_edited: "2024-06-10", is_current: true, domain: "MetaData", subdomain: "", index_id: 101, name: "Student ID" },
            { layout_id: 2, layout_name: 'Cognitive Layout', date_edited: "2024-05-20", is_current: false, domain: "Cognitive Development", subdomain: "Problem Solving", index_id: 4, name: "Solve this puzzle" },
            { layout_id: 2, layout_name: 'Cognitive Layout', date_edited: "2024-05-20", is_current: false, domain: "MetaData", subdomain: "", index_id: 102, name: "Assessment Date" }
        ];
    } catch (e) {
        return [];
    }
}

function buildLayoutStructure(questions, layout_id) {
    const domains = {};
    const metadata = [];
    questions.forEach(q => {
        if (q.layout_id !== layout_id) return;
        if (q.domain === "MetaData") {
            metadata.push({ name: q.name, question_id: q.index_id });
        } else {
            if (!domains[q.domain]) domains[q.domain] = {};
            if (!domains[q.domain][q.subdomain]) domains[q.domain][q.subdomain] = [];
            domains[q.domain][q.subdomain].push({ name: q.name, question_id: q.index_id });
        }
    });
    // Convert to array structure
    return {
        domains: Object.entries(domains).map(([domainName, subdomainsObj]) => ({
            name: domainName,
            subdomains: Object.entries(subdomainsObj).map(([subName, questions]) => ({
                name: subName,
                questions
            }))
        })),
        metadata
    };
}

// ========================================
// INITIALIZATION
// ========================================
async function initializeLayout() {
    try {
        const layout_id = getLayoutIdFromUrl();
        const questions = await fetchAllQuestions();
        // Find the first question with this layout_id to get the layout_name
        const layoutRow = questions.find(q => q.layout_id === layout_id);
        const layout_name = layoutRow && layoutRow.layout_name ? layoutRow.layout_name : 'Layout Viewer';
        document.getElementById('layoutNameHeader').textContent = layout_name;
        document.getElementById('layoutIdHeader').textContent = layout_id ? `ID: ${layout_id}` : '';
        layoutData = buildLayoutStructure(questions, layout_id);
        renderLayout();
    } catch (error) {
        console.error('Error initializing layout:', error);
    }
}

// ========================================
// RENDERING FUNCTIONS (Read-only version)
// ========================================
function renderLayout() {
    renderDomains();
    renderMetadata();
}

function renderDomains() {
    const container = document.getElementById('domainsContainer');
    container.innerHTML = '';
    
    layoutData.domains.forEach(domain => {
        const domainHtml = `
            <div class="domain-card mb-4">
                <div class="card border-primary border-3 rounded-4 shadow-lg">
                    <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-diagram-3 text-primary me-2"></i>
                            <span class="fw-bold text-primary">${domain.name}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderSubdomains(domain)}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += domainHtml;
    });
}

function renderSubdomains(domain) {
    let subdomainsHtml = '';
    
    domain.subdomains.forEach(subdomain => {
        subdomainsHtml += `
            <div class="subdomain-card mb-3 ms-4">
                <div class="card border-secondary border-2 rounded-3">
                    <div class="card-header bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-collection text-secondary me-2"></i>
                            <span class="fw-semibold text-secondary">${subdomain.name}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderQuestions(domain.id, subdomain)}
                    </div>
                </div>
            </div>
        `;
    });
    
    return subdomainsHtml;
}

function renderQuestions(domainId, subdomain) {
    let questionsHtml = '';
    
    subdomain.questions.forEach(question => {
        questionsHtml += `
            <div class="question-row mb-2 ms-4">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${question.name}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${question.question_id}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted text-center pt-2">
                            <i class="bi bi-eye"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    return questionsHtml;
}

function renderMetadata() {
    const container = document.getElementById('metadataContainer');
    container.innerHTML = '';
    
    layoutData.metadata.forEach(metadata => {
        const metadataHtml = `
            <div class="metadata-row mb-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${metadata.name}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-control form-control-sm border-info border-2 rounded-3 bg-light">
                            ${metadata.question_id}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted text-center pt-2">
                            <i class="bi bi-lock"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += metadataHtml;
    });
}

// ========================================
// INITIALIZATION
// ========================================
async function initializeLayout() {
    try {
        const data = await fetchCurrentLayout();
        layoutData = data;
        renderLayout();
    } catch (error) {
        console.error('Error initializing layout:', error);
    }
}

$(document).ready(function() {
    initializeLayout();
});
</script>
{% endblock %} 