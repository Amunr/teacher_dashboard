{% extends "layout.html" %}

{% block title %}Maintenance Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold">Maintenance Dashboard</h2>
            <p class="text-muted">Manage responses, student counts, and system data</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="maintenanceTabs">
                <li class="nav-item">
                    <a class="nav-link active" id="responses-tab" data-bs-toggle="tab" href="#responses">
                        Responses <span class="badge bg-primary">{{ pagination.total }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="student-counts-tab" data-bs-toggle="tab" href="#student-counts">
                        Student Counts <span class="badge bg-success">{{ student_counts|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="sheets-tab" data-bs-toggle="tab" href="#sheets">
                        Google Sheets <span class="badge bg-info" id="sheetsStatusBadge">Not Configured</span>
                    </a>
                </li>
                {% if orphaned_responses %}
                <li class="nav-item">
                    <a class="nav-link text-warning" id="orphaned-tab" data-bs-toggle="tab" href="#orphaned">
                        Orphaned Responses <span class="badge bg-warning">{{ orphaned_responses|length }}</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="tab-content" id="maintenanceTabContent">
        <!-- Responses Tab -->
        <div class="tab-pane fade show active" id="responses" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-8">
                    <h4>Response Records</h4>
                    <p class="text-muted">View and manage all response data</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-danger" id="deleteSelectedBtn" disabled>
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                </div>
            </div>

            <!-- Responses Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Res ID</th>
                                    <th>Student Name</th>
                                    <th>School</th>
                                    <th>Grade</th>
                                    <th>Teacher</th>
                                    <th>Assessment</th>
                                    <th>Date</th>
                                    <th>Domain</th>
                                    <th>Question</th>
                                    <th>Response</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in responses %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input response-select" 
                                               value="{{ response['res-id'] }}" data-res-id="{{ response['res-id'] }}">
                                    </td>
                                    <td>{{ response['res-id'] }}</td>
                                    <td>{{ response.Name or '-' }}</td>
                                    <td>{{ response.School or '-' }}</td>
                                    <td>{{ response.Grade or '-' }}</td>
                                    <td>{{ response.Teacher or '-' }}</td>
                                    <td>{{ response.Assessment or '-' }}</td>
                                    <td>{{ response.Date or '-' }}</td>
                                    <td>{{ response.Domain or '-' }}</td>
                                    <td>{{ response.Question_Name or '-' }}</td>
                                    <td>{{ response.Response }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if pagination.pages > 1 %}
                    <div class="d-flex justify-content-center mt-3">
                        <nav>
                            <ul class="pagination">
                                {% if pagination.page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ pagination.page - 1 }}">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in range(1, pagination.pages + 1) %}
                                <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
                                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}
                                
                                {% if pagination.page < pagination.pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ pagination.page + 1 }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Student Counts Tab -->
        <div class="tab-pane fade" id="student-counts" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-8">
                    <h4>Total Student Counts</h4>
                    <p class="text-muted">Manage manual student count entries for different date ranges</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#studentCountModal">
                        <i class="bi bi-plus"></i> Add New Count
                    </button>
                </div>
            </div>

            <!-- Student Counts Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Total Students</th>
                                    <th>Description</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for count in student_counts %}
                                <tr>
                                    <td>{{ count.id }}</td>
                                    <td>{{ count.start_date }}</td>
                                    <td>{{ count.end_date }}</td>
                                    <td>{{ count.total_students }}</td>
                                    <td>{{ count.description or '-' }}</td>
                                    <td>{{ count.created_at }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary edit-count-btn" 
                                                data-id="{{ count.id }}"
                                                data-start="{{ count.start_date }}"
                                                data-end="{{ count.end_date }}"
                                                data-total="{{ count.total_students }}"
                                                data-description="{{ count.description or '' }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-count-btn" 
                                                data-id="{{ count.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orphaned Responses Tab -->
        {% if orphaned_responses %}
        <div class="tab-pane fade" id="orphaned" role="tabpanel">
            <div class="row mb-3">
                <div class="col-12">
                    <h4 class="text-warning">Orphaned Responses</h4>
                    <p class="text-muted">Responses without valid question mappings for their dates</p>
                </div>
            </div>

            <div class="card border-warning">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-warning">
                                <tr>
                                    <th>Res ID</th>
                                    <th>Student Name</th>
                                    <th>Date</th>
                                    <th>Index ID</th>
                                    <th>Response</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in orphaned_responses %}
                                <tr>
                                    <td>{{ response['res-id'] }}</td>
                                    <td>{{ response.Name or '-' }}</td>
                                    <td>{{ response.Date or '-' }}</td>
                                    <td>{{ response.Index_ID }}</td>
                                    <td>{{ response.Response }}</td>
                                    <td><span class="badge bg-warning">No question mapping for date</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Google Sheets Tab Content -->
<div class="tab-pane fade" id="sheets" role="tabpanel">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Google Sheets Configuration</h5>
                    <div>
                        <span id="connectionStatus" class="badge bg-secondary">Unknown</span>
                        <button class="btn btn-outline-primary btn-sm ms-2" id="testConnection">
                            <i class="bi bi-wifi"></i> Test Connection
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="sheetsConfigForm">
                        <div class="mb-3">
                            <label for="sheetUrl" class="form-label">Google Sheets URL</label>
                            <input type="url" class="form-control" id="sheetUrl" name="sheet_url" 
                                   placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit">
                            <div class="form-text">
                                Paste the full Google Sheets URL. Make sure the sheet is publicly accessible or shared with view permissions.
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="pollInterval" class="form-label">Poll Interval (minutes)</label>
                                <input type="number" class="form-control" id="pollInterval" name="poll_interval" 
                                       min="1" max="1440" value="5">
                                <div class="form-text">How often to check for new data (1-1440 minutes)</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <div class="d-flex align-items-center">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input" type="checkbox" id="isActive" name="is_active">
                                        <label class="form-check-label" for="isActive">Active</label>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger btn-sm" id="deactivatePolling">
                                        <i class="bi bi-stop-circle"></i> Stop Polling
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Configuration
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" id="resetForm">
                                Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Import Statistics</h6>
                </div>
                <div class="card-body">
                    <div id="importStats">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Last Import:</small>
                            <small id="lastImport">Never</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Last Row Processed:</small>
                            <small id="lastRowProcessed">0</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Total Imported:</small>
                            <small id="totalImported">0</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Failed Imports:</small>
                            <small id="failedImports" class="text-danger">0</small>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <small class="text-muted">Next Poll:</small>
                            <small id="nextPoll">-</small>
                        </div>
                        
                        <!-- Manual Last Row Setting -->
                        <div class="border-top pt-3">
                            <div class="d-flex align-items-center mb-2">
                                <small class="text-muted me-2">Set Last Row:</small>
                                <input type="number" class="form-control form-control-sm" id="manualLastRow" 
                                       min="1" max="10000" style="width: 80px;" placeholder="1" value="1">
                                <button type="button" class="btn btn-outline-primary btn-sm ms-2" id="setLastRowBtn">
                                    Set
                                </button>
                            </div>
                            <small class="text-muted">For testing: manually set which row to process next (minimum 1, header row always skipped)</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-info btn-sm w-100 mt-3" id="refreshStats">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Service Control</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Polling Service:</small>
                        <span id="serviceStatus" class="badge bg-secondary">Unknown</span>
                    </div>
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" id="startService">
                        <i class="bi bi-play-circle"></i> Start Service
                    </button>
                    <button class="btn btn-outline-danger btn-sm w-100 mb-2" id="stopService">
                        <i class="bi bi-stop-circle"></i> Stop Service
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100" id="checkServiceStatus">
                        <i class="bi bi-question-circle"></i> Check Status
                    </button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" id="manualImport">
                        <i class="bi bi-download"></i> Manual Import Now
                    </button>
                    <button class="btn btn-outline-warning btn-sm w-100" id="viewFailedImports">
                        <i class="bi bi-exclamation-triangle"></i> View Failed Imports
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Failed Imports Section -->
    <div class="row mt-4" id="failedImportsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Failed Imports</h6>
                    <div>
                        <button class="btn btn-outline-success btn-sm" id="retryAllFailed">
                            <i class="bi bi-arrow-clockwise"></i> Retry All
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-2" id="deleteAllFailed">
                            <i class="bi bi-trash"></i> Delete All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Row</th>
                                    <th>Error</th>
                                    <th>Data</th>
                                    <th>Failed At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="failedImportsTable">
                                <!-- Failed imports will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Count Modal -->
<div class="modal fade" id="studentCountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentCountModalTitle">Add Student Count</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentCountForm">
                    <input type="hidden" id="countId" name="countId">
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" name="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" name="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="totalStudents" class="form-label">Total Students</label>
                        <input type="number" class="form-control" id="totalStudents" name="totalStudents" 
                               min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveStudentCount">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const responseCheckboxes = document.querySelectorAll('.response-select');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    selectAllCheckbox.addEventListener('change', function() {
        responseCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateDeleteButton();
    });

    responseCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButton);
    });

    function updateDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.response-select:checked');
        deleteSelectedBtn.disabled = checkedBoxes.length === 0;
        
        // Update select all checkbox state
        if (checkedBoxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedBoxes.length === responseCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Delete selected responses
    deleteSelectedBtn.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.response-select:checked');
        const resIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
        
        if (resIds.length === 0) return;

        if (confirm(`Are you sure you want to delete ${resIds.length} response record(s)?`)) {
            fetch('/api/maintenance/delete-responses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ res_ids: resIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete responses');
            });
        }
    });

    // Student count modal functionality
    const modal = new bootstrap.Modal(document.getElementById('studentCountModal'));
    const form = document.getElementById('studentCountForm');
    const saveBtn = document.getElementById('saveStudentCount');

    // Edit student count
    document.querySelectorAll('.edit-count-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const startDate = this.dataset.start;
            const endDate = this.dataset.end;
            const total = this.dataset.total;
            const description = this.dataset.description;

            document.getElementById('studentCountModalTitle').textContent = 'Edit Student Count';
            document.getElementById('countId').value = id;
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            document.getElementById('totalStudents').value = total;
            document.getElementById('description').value = description;

            modal.show();
        });
    });

    // Add new student count
    document.querySelector('[data-bs-target="#studentCountModal"]').addEventListener('click', function() {
        document.getElementById('studentCountModalTitle').textContent = 'Add Student Count';
        form.reset();
        document.getElementById('countId').value = '';
    });

    // Save student count
    saveBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        const data = {
            start_date: formData.get('startDate'),
            end_date: formData.get('endDate'),
            total_students: parseInt(formData.get('totalStudents')),
            description: formData.get('description')
        };

        const countId = formData.get('countId');
        const url = countId ? `/api/maintenance/student-counts/${countId}` : '/api/maintenance/student-counts';
        const method = countId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modal.hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to save student count');
        });
    });

    // Delete student count
    document.querySelectorAll('.delete-count-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            
            if (confirm('Are you sure you want to delete this student count entry?')) {
                fetch(`/api/maintenance/student-counts/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete student count');
                });
            }
        });
    });

    // Google Sheets functionality
    loadSheetsConfig();
    
    // Load Google Sheets configuration
    function loadSheetsConfig() {
        fetch('/api/sheets/config/status')
            .then(response => response.json())
            .then(data => {
                if (data.configured) {
                    document.getElementById('sheetUrl').value = data.sheet_url || '';
                    document.getElementById('pollInterval').value = data.poll_interval || 5;
                    document.getElementById('isActive').checked = data.active || false;
                    document.getElementById('lastRowProcessed').textContent = data.last_row_processed || 0;
                    
                    // Update status based on configured and active state
                    updateConnectionStatus(data.configured, data.active);
                } else {
                    // No configuration found
                    document.getElementById('sheetUrl').value = '';
                    document.getElementById('pollInterval').value = 5;
                    document.getElementById('isActive').checked = false;
                    document.getElementById('lastRowProcessed').textContent = '0';
                    updateConnectionStatus(false, false);
                }
                loadImportStats();
            })
            .catch(error => {
                console.error('Error loading config:', error);
                updateConnectionStatus(false, false);
            });
    }

    // Save Google Sheets configuration
    document.getElementById('sheetsConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const config = {
            sheet_url: formData.get('sheet_url'),
            poll_interval: parseInt(formData.get('poll_interval')),
            is_active: formData.get('is_active') !== null
        };

        fetch('/api/sheets/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Configuration saved successfully!', 'success');
                // Auto-start the service if configuration is active
                if (config.is_active) {
                    setTimeout(() => {
                        startPollingService();
                        // Additional check - start service again after 2 seconds if needed
                        setTimeout(() => {
                            checkServiceStatus();
                        }, 2000);
                    }, 500);
                }
                // Force reload configuration to update UI immediately
                setTimeout(() => {
                    loadSheetsConfig();
                    loadImportStats();
                }, 1000);
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to save configuration', 'danger');
        });
    });

    // Test connection
    document.getElementById('testConnection').addEventListener('click', function() {
        const sheetUrl = document.getElementById('sheetUrl').value;
        if (!sheetUrl) {
            showAlert('Please enter a Google Sheets URL first', 'warning');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';

        fetch('/api/sheets/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sheet_url: sheetUrl })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateConnectionStatus(true, true);
                showAlert(`Connection successful! Found ${data.total_rows || 'unknown number of'} rows.`, 'success');
            } else {
                updateConnectionStatus(false, false);
                showAlert('Connection failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            updateConnectionStatus(false, false);
            showAlert('Connection test failed', 'danger');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-wifi"></i> Test Connection';
        });
    });

    // Load import statistics
    function loadImportStats() {
        fetch('/api/sheets/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('lastImport').textContent = stats.last_import || 'Never';
                    document.getElementById('totalImported').textContent = stats.total_imported || 0;
                    document.getElementById('failedImports').textContent = stats.failed_imports || 0;
                    document.getElementById('nextPoll').textContent = stats.next_poll || '-';
                    
                    // Update failed imports badge
                    const failedCount = stats.failed_imports || 0;
                    const sheetsTab = document.querySelector('a[href="#sheets"] .badge');
                    if (sheetsTab) {
                        if (failedCount > 0) {
                            sheetsTab.textContent = failedCount;
                            sheetsTab.className = 'badge bg-danger ms-1';
                            sheetsTab.style.display = 'inline';
                        } else {
                            sheetsTab.style.display = 'none';
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }

    // Refresh stats
    document.getElementById('refreshStats').addEventListener('click', function() {
        loadImportStats();
        showAlert('Statistics refreshed', 'info');
    });

    // Manual import
    document.getElementById('manualImport').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';

        fetch('/api/sheets/import', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`Import completed! Processed ${data.processed_rows} new rows.`, 'success');
                loadImportStats();
            } else {
                showAlert('Import failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Manual import failed', 'danger');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-download"></i> Manual Import Now';
        });
    });

    // View failed imports
    document.getElementById('viewFailedImports').addEventListener('click', function() {
        const section = document.getElementById('failedImportsSection');
        if (section.style.display === 'none') {
            loadFailedImports();
            section.style.display = 'block';
            this.innerHTML = '<i class="bi bi-eye-slash"></i> Hide Failed Imports';
        } else {
            section.style.display = 'none';
            this.innerHTML = '<i class="bi bi-exclamation-triangle"></i> View Failed Imports';
        }
    });

    // Load failed imports
    function loadFailedImports() {
        fetch('/api/sheets/failed-imports')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('failedImportsTable');
                tbody.innerHTML = '';
                
                if (data.success && data.failed_imports.length > 0) {
                    data.failed_imports.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.row_number}</td>
                            <td><small class="text-danger">${item.error_message}</small></td>
                            <td><small>${JSON.stringify(item.row_data).substring(0, 100)}...</small></td>
                            <td><small>${new Date(item.failed_at).toLocaleString()}</small></td>
                            <td>
                                <button class="btn btn-outline-success btn-sm me-1" onclick="retryFailedImport(${item.id})">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteFailedImport(${item.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No failed imports</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading failed imports:', error);
            });
    }

    // Retry all failed imports
    document.getElementById('retryAllFailed').addEventListener('click', function() {
        if (confirm('Retry all failed imports?')) {
            fetch('/api/sheets/retry-failed', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Retried ${data.retried_count} failed imports.`, 'success');
                    loadFailedImports();
                    loadImportStats();
                } else {
                    showAlert('Retry failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Retry operation failed', 'danger');
            });
        }
    });

    // Delete all failed imports
    document.getElementById('deleteAllFailed').addEventListener('click', function() {
        if (confirm('Delete all failed import records? This cannot be undone.')) {
            fetch('/api/sheets/failed-imports', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('All failed imports deleted.', 'success');
                    loadFailedImports();
                    loadImportStats();
                } else {
                    showAlert('Delete failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Delete operation failed', 'danger');
            });
        }
    });

    // Service Control Functions
    function startPollingService() {
        fetch('/api/sheets/service/start', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Polling service started successfully!', 'success');
                checkServiceStatus();
            } else {
                showAlert('Failed to start service: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to start polling service', 'danger');
        });
    }

    function stopPollingService() {
        fetch('/api/sheets/service/stop', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Polling service stopped: ' + data.message, 'warning');
                checkServiceStatus();
            } else {
                showAlert('Failed to stop service: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to stop polling service', 'danger');
        });
    }

    function checkServiceStatus() {
        fetch('/api/sheets/service/status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('serviceStatus');
            if (data.success) {
                if (data.running) {
                    statusElement.textContent = `Running (${data.count} process(es))`;
                    statusElement.className = 'badge bg-success';
                } else {
                    statusElement.textContent = 'Stopped';
                    statusElement.className = 'badge bg-secondary';
                }
            } else {
                statusElement.textContent = 'Error';
                statusElement.className = 'badge bg-danger';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const statusElement = document.getElementById('serviceStatus');
            statusElement.textContent = 'Error';
            statusElement.className = 'badge bg-danger';
        });
    }

    // Service Control Event Listeners
    document.getElementById('startService').addEventListener('click', startPollingService);
    document.getElementById('stopService').addEventListener('click', stopPollingService);
    document.getElementById('checkServiceStatus').addEventListener('click', checkServiceStatus);

    // Initial service status check and auto-start if needed
    checkServiceStatus();
    
    // Check if service should auto-start on page load
    setTimeout(() => {
        checkAndAutoStartService();
    }, 2000);
    checkServiceStatus();

    // Deactivate polling
    document.getElementById('deactivatePolling').addEventListener('click', function() {
        if (confirm('Stop Google Sheets polling? This will deactivate automatic imports.')) {
            fetch('/api/sheets/deactivate', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Polling deactivated.', 'warning');
                    loadSheetsConfig();
                } else {
                    showAlert('Deactivation failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Deactivation failed', 'danger');
            });
        }
    });

    // Reset form
    document.getElementById('resetForm').addEventListener('click', function() {
        if (confirm('Reset form to saved values?')) {
            loadSheetsConfig();
        }
    });

    // Set Last Row functionality
    document.getElementById('setLastRowBtn').addEventListener('click', function() {
        const lastRowInput = document.getElementById('manualLastRow');
        const lastRow = parseInt(lastRowInput.value);
        
        if (isNaN(lastRow) || lastRow < 1) {
            showAlert('Please enter a valid row number (1 or greater). Note: Header row is always skipped.', 'warning');
            return;
        }
        
        if (confirm(`Set last processed row to ${lastRow}? This will affect which rows are imported next. The header row (row 1) is always automatically skipped.`)) {
            fetch('/api/sheets/set-last-row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ row_number: lastRow })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Last row set to ${lastRow}. Next import will start from row ${lastRow + 1} (header row always skipped).`, 'success');
                    loadSheetsConfig(); // Refresh to show updated value
                    lastRowInput.value = '1'; // Reset to default
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to set last row', 'danger');
            });
        }
    });

    // Helper functions
    function updateConnectionStatus(isConfigured, isActive) {
        const statusElement = document.getElementById('connectionStatus');
        const tabBadge = document.getElementById('sheetsStatusBadge');
        
        if (isConfigured && isActive) {
            statusElement.textContent = 'Active';
            statusElement.className = 'badge bg-success';
            tabBadge.textContent = 'Active';
            tabBadge.className = 'badge bg-success';
        } else if (isConfigured && !isActive) {
            statusElement.textContent = 'Configured (Inactive)';
            statusElement.className = 'badge bg-warning';
            tabBadge.textContent = 'Inactive';
            tabBadge.className = 'badge bg-warning';
        } else {
            statusElement.textContent = 'Not Configured';
            statusElement.className = 'badge bg-secondary';
            tabBadge.textContent = 'Not Configured';
            tabBadge.className = 'badge bg-info';
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Global functions for inline onclick handlers
    window.retryFailedImport = function(id) {
        fetch(`/api/sheets/retry-failed/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Import retried successfully.', 'success');
                loadFailedImports();
                loadImportStats();
            } else {
                showAlert('Retry failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Retry failed', 'danger');
        });
    };

    window.deleteFailedImport = function(id) {
        if (confirm('Delete this failed import record?')) {
            fetch(`/api/sheets/failed-imports/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Failed import deleted.', 'success');
                    loadFailedImports();
                    loadImportStats();
                } else {
                    showAlert('Delete failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Delete failed', 'danger');
            });
        }
    };

    // Refresh stats periodically when on sheets tab
    setInterval(function() {
        const sheetsTab = document.getElementById('sheets');
        if (sheetsTab && sheetsTab.classList.contains('active')) {
            loadImportStats();
            checkServiceStatus();
            
            // Auto-start service if it should be running but isn't
            checkAndAutoStartService();
        }
    }, 30000); // Refresh every 30 seconds when tab is active

    // Check if service should be running and auto-start if needed
    function checkAndAutoStartService() {
        // Only check if we have an active configuration
        const isActiveCheckbox = document.getElementById('isActive');
        if (isActiveCheckbox && isActiveCheckbox.checked) {
            fetch('/api/sheets/service/status')
            .then(response => response.json())
            .then(data => {
                if (data.success && !data.running) {
                    console.log('Service should be running but is stopped. Auto-starting...');
                    startPollingService();
                }
            })
            .catch(error => {
                console.error('Error checking service status:', error);
            });
        }
    }

    // Enhanced periodic check every 5 minutes for service health
    setInterval(function() {
        checkAndAutoStartService();
    }, 300000); // Check every 5 minutes
});
</script>
{% endblock %}
